trigger:
  branches:
    include:
      - main

variables:
  awsRegion: 'ap-south-1'
  ecrRepo: '<ACCOUNT_ID>.dkr.ecr.ap-south-1.amazonaws.com/allure-dashboard'
  imageName: 'allure-dashboard'

stages:
  - stage: Build
    displayName: Build & Push
    jobs:
      - job: Build
        pool:
          vmImage: 'ubuntu-latest'
        steps:

          - task: Maven@3
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'clean package -DskipTests'

          - script: |
              echo "Logging in to AWS ECR"
              aws --version
              aws configure set aws_access_key_id $(AWS_ACCESS_KEY_ID)
              aws configure set aws_secret_access_key $(AWS_SECRET_ACCESS_KEY)
              aws configure set default.region $(awsRegion)
              aws ecr get-login-password --region $(awsRegion) | docker login --username AWS --password-stdin <ACCOUNT_ID>.dkr.ecr.ap-south-1.amazonaws.com
            env:
              AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
              AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
            displayName: 'ECR Login'

          - script: |
              docker build -t $(imageName):$(Build.BuildId) .
              docker tag $(imageName):$(Build.BuildId) $(ecrRepo):$(Build.BuildId)
            displayName: 'Build Dockerfile Image'

          - script: |
              docker push $(ecrRepo):$(Build.BuildId)
            displayName: 'Push to ECR'

          # optional: deploy to ECS (see below) - uses aws cli to update service
          - script: |
              printf 'Deploying to ECS (update service with new image)...\n'
              aws ecs update-service --cluster my-allure-cluster --service my-allure-service --force-new-deployment --region $(awsRegion)
            displayName: 'ECS deploy'
            condition: succeeded()
            env:
              AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
              AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
